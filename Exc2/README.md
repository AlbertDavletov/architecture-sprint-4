# Задание 2. Выбор и настройка мониторинга в системе

Сайт «Александрит» подключён к Яндекс Метрике. Но с тех пор, как бизнес начал предоставлять оформление заказов через API, данные Яндекс Метрики уже не дают полной картины. 

Чтобы начать улучшать систему, вам нужно от чего-то отталкиваться. В этом задании вы запланируете внедрение мониторинга.
Вам нужно определить, что вы хотите измерять и как вы будете это делать. А затем —  постараться обосновать свои решения для бизнеса. Не забывайте: бизнесу не всегда очевидно, что мониторинг стоит того, чтобы выделять на него ресурсы команды.

## Мотивация

- Одни из главных проблем сайта - это задержки в обработке и "потеря" некоторых заказов. Внедрение мониторинга, логирования и трейсинга позволит определить проблемные места и сервисы, которые необходимо исправить в первую очередь.
- Многие проблемные места сайта видны невооруженным взглядом, поэтому отчеты мониторинга помогут обосновать правильность стратегии и приоритетов работы над блоками системы для бизнеса.
- В будущем система мониторинга поможет оперативно выявлять будущие узкие места и команда сможет быстро настраивать систему под большую нагрузку.
- Основные метрики системы (среднее время обработки заказов, количество ошибок, нагрузка MES API) позволят эффективно оценивать стабильность и доступность сайта. Также это позволит использовать ресурсы эффективно, рационально используя деньги компании.

## Выбор подхода к мониторингу

1. Онлайн-магазин: RED метод. Здесь важны среднее время ответа запросов, общее количество запросов (RPS) и процент ошибок. Также можно вывести на дашборд размер БД онлайн-магазина, а также среднее количество запросов пользователя, чтобы реагировать на подозрительную активность. Основные метрики:
    - Response time (latency) for shop API
    - Number of requests (RPS) per user for internet shop API
    - Number of requests (RPS) for internet shop API
    - Number of connections for shop db instance
    - Number of HTTP 500 for shop API
    - Number of HTTP 200 for shop API
    - Size of shop db instance

2. CRM: RED метод. Здесь также важны среднее время ответа запросов, общее количество запросов (RPS) и процент ошибок. Также отдельно нужно следить за очередью сообщений RabbitMQ: количество сообщений, количество необработанных сообщений. Основные метрики:
    - Response time (latency) for CRM API
    - Number of requests (RPS) for CRM API
    - Number of requests (RPS) per user for CRM API
    - Number of message in flight in RabbitMQ
    - Number of connections for MES db instance
    - Number of HTTP 200 for CRM API
    - Number of HTTP 500 for CRM API
    - Size of S3 storage

3. MES API: 4 золотых сигнала. Этот метод подойдет для системы, которая предоставляет API. Здесь следим за средним временем ответа запросов, количество запросов в секунду и процент ошибок. Также одним из важных метрик в данном случае будет процент загрузки CPU, т.к. операции постройки 3D полигонов требует большей нагрузки на процессор. Основные метрики:
    - Response time (latency) for MES API
    - Number of requests (RPS) for MES API
    - Number of requests (RPS) per user for MES API
    - CPU % for MES API
    - Number of HTTP 200 for MES API
    - Number of HTTP 500 for MES API
    - Size of MES db instance

Метод USE не подойдет для систем, использующих кэширование.

## План действий

1. Устанавливаем и настраиваем систему мониторинга, например Prometheus, для каждого приложения нашей системы.
2. Настраиваем визуализацию основным метрик, например с помощью Grafana.
3. Создаем 3 основных дашборда: Онлайн-магазин, CRM, MES.
4. Настраиваем критические алерты в системе. Например, 
    - процент неудачных запросов больше N за X минут.
    - RPS выше 80% от максимального допустимого значения.
    - размер БД больше 80%.
5. Сделать подробную документацию: описать все основные метрики, методика сбора и логика алертов.
6. Подготовить отчеты мониторинга за N недель для бизнеса.
